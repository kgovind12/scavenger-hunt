<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ikea Hiders Upload</title>
  <style>
    body {
      background-color: #FFD700;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      padding-top: 100px;
    }

    header {
      text-align: center;
      font-size: 26px;
      font-weight: bold;
      margin-bottom: 40px;
    }

    #found-button {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 15px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
    }

    #help-button {
      position: fixed;
      top: 20px;
      left: 20px;
      background-color: #ff2700;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 15px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
    }

    .category-section {
      background-color: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.1);
      border-left: 5px solid royalblue;
      display: flex;
      flex-direction: column;
    }

    .category-section h3 {
      margin-top: 0;
    }

    .upload-box {
      border: 2px dashed royalblue;
      padding: 10px;
      display: inline-block;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .upload-box input[type="file"] {
      border: none;
      background: none;
    }

    .upload-preview {
      margin-top: 10px;
      max-width: 100px;
      max-height: 100px;
      border-radius: 8px;
    }

    .success-message {
      color: green;
      font-size: 14px;
      margin-top: 8px;
    }

    /* Popup Styles */
    .popup-overlay {
      position: fixed;
      inset: 0;
      z-index: 999;
      animation: fadeIn 0.3s ease-in-out;
    }

    .popup-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
    }

    .popup-container {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px 25px;
      border-radius: 16px;
      box-shadow: 0 12px 25px rgba(0, 0, 0, 0.2);
      width: 300px;
      text-align: center;
      font-family: Arial, sans-serif;
      z-index: 1000;
    }

    .popup-container h2 {
      margin-top: 0;
      margin-bottom: 20px;
    }

    .popup-container p {
      margin-bottom: 10px;
      font-size: 14px;
      color: #555;
    }

    .popup-container input[type="text"] {
      width: 80%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 14px;
    }

    .popup-buttons button {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      margin-right: 10px;
    }

    #submit-name {
      background-color: #007bff;
      color: white;
    }

    #close-popup {
      background-color: #ccc;
      color: black;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    #all-items-ok {
      background-color: #007bff;
      color: white;
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }

  </style>
</head>
<body>

  <button id="found-button">I've been found!</button>
  <button id="help-button" onclick="openSMS()">Help</button>

  <header>Welcome Ikea Hiders, upload pictures of your items here!</header>

  <form id="uploadForm">
    <!-- Repeatable category block -->
    <div class="category-section" data-category="red">
      <h3>Something red</h3>
      <div class="upload-box">
        <input type="file" name="red" accept="image/*" capture="camera" />
      </div>
      <img class="upload-preview" />
      <div class="success-message"></div>
    </div>

    <div class="category-section" data-category="leaf">
      <h3>A leaf</h3>
      <div class="upload-box">
        <input type="file" name="red" accept="image/*" capture="camera" />
      </div>
      <img class="upload-preview" />
      <div class="success-message"></div>
    </div>

    <div class="category-section" data-category="circle">
      <h3>A circle</h3>
      <div class="upload-box">
        <input type="file" name="red" accept="image/*" capture="camera" />
      </div>
      <img class="upload-preview" />
      <div class="success-message"></div>
    </div>

    <div class="category-section" data-category="toy">
      <h3>A toy</h3>
      <div class="upload-box">
        <input type="file" name="red" accept="image/*" capture="camera" />
      </div>
      <img class="upload-preview" />
      <div class="success-message"></div>
    </div>

    <div class="category-section" data-category="reflection">
      <h3>A reflection</h3>
      <div class="upload-box">
        <input type="file" name="red" accept="image/*" capture="camera" />
      </div>
      <img class="upload-preview" />
      <div class="success-message"></div>
    </div>

    <div class="category-section" data-category="soft">
      <h3>Something soft</h3>
      <div class="upload-box">
        <input type="file" name="red" accept="image/*" capture="camera" />
      </div>
      <img class="upload-preview" />
      <div class="success-message"></div>
    </div>

    <div class="category-section" data-category="triangle">
      <h3>A triangle</h3>
      <div class="upload-box">
        <input type="file" name="red" accept="image/*" capture="camera" />
      </div>
      <img class="upload-preview" />
      <div class="success-message"></div>
    </div>

    <div class="category-section" data-category="old">
      <h3>Something old</h3>
      <div class="upload-box">
        <input type="file" name="red" accept="image/*" capture="camera" />
      </div>
      <img class="upload-preview" />
      <div class="success-message"></div>
    </div>

    <div class="category-section" data-category="funny">
      <h3>Something funny</h3>
      <div class="upload-box">
        <input type="file" name="red" accept="image/*" capture="camera" />
      </div>
      <img class="upload-preview" />
      <div class="success-message"></div>
    </div>

    <div class="category-section" data-category="tall">
      <h3>Something tall</h3>
      <div class="upload-box">
        <input type="file" name="red" accept="image/*" capture="camera" />
      </div>
      <img class="upload-preview" />
      <div class="success-message"></div>
    </div>
  </form>

    <!-- Found Popup -->
    <div id="found-popup" class="popup-overlay" style="display: none;">
      <div class="popup-backdrop"></div>

      <div class="popup-container">
        <h2>You've been found!</h2>
        <p>Please enter your player number:</p>
        <input type="text" id="finder-name" placeholder="Your player number" />
        <div class="popup-buttons">
          <button id="submit-name">Submit</button>
          <button id="close-popup">Cancel</button>
        </div>
      </div>
    </div>

    <!-- All Items Found Popup -->
    <div id="all-items-popup" class="popup-overlay" style="display: none;">
      <div class="popup-backdrop"></div>
      <div class="popup-container">
        <h2>🎉 Congratulations!</h2>
        <p>You have found all the hidden items! Please return to the home base.</p>
        <button id="all-items-ok">OK</button>
      </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

  <script>
      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyC1RdUtKa1cZ0osTSZd93GdcbOS0w54JYU",
        authDomain: "scavenger-hunt-4173c.firebaseapp.com",
        databaseURL: "https://scavenger-hunt-4173c-default-rtdb.firebaseio.com",
        projectId: "scavenger-hunt-4173c",
        storageBucket: "scavenger-hunt-4173c.firebasestorage.app",
        messagingSenderId: "265944270299",
        appId: "1:265944270299:web:baef35722c962f1a0853fe",
        measurementId: "G-PT9XTPCF1H"
      };

      
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const foundButton = document.getElementById('found-button');
  const popup = document.getElementById('found-popup');
  const submitBtn = document.getElementById('submit-name');
  const closeBtn = document.getElementById('close-popup');
  const nameInput = document.getElementById('finder-name');

  foundButton.addEventListener('click', () => {
    popup.style.display = 'block';
    nameInput.value = '';
  });

  closeBtn.addEventListener('click', () => {
    popup.style.display = 'none';
  });

  submitBtn.addEventListener('click', async () => {
  const name = nameInput.value.trim();
  if (!name) return alert("Please enter your player number.");

  try {
    const hidersRef = db.collection('hiders');
    const existing = await hidersRef.where('name', '==', name).get();

    if (!existing.empty) {
      alert(`Player ${name}, you have already been found. Please return to home base.`);
      popup.style.display = 'none';
      return;
    }

    // Add the new hider
    await hidersRef.add({ name });

    // Increment hidersFound in meta/status
    const metaRef = db.collection('meta').doc('status');
    await db.runTransaction(async (transaction) => {
      const metaDoc = await transaction.get(metaRef);
      if (!metaDoc.exists) {
        transaction.set(metaRef, { hidersFound: 1 });
      } else {
        const current = metaDoc.data().hidersFound || 0;
        transaction.update(metaRef, { hidersFound: current + 1 });
      }
    });

    // Hide popup and redirect
    popup.style.display = 'none';
    window.location.href = "/endgame.html";

  } catch (err) {
    console.error(err);
    alert("Something went wrong. Please try again.");
  }
});


  // 🔁 Handle all file inputs
  document.querySelectorAll('input[type="file"]').forEach(input => {
    input.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      const section = e.target.closest('.category-section');
      const preview = section.querySelector('.upload-preview');
      const successMsg = section.querySelector('.success-message');
      const category = section.getAttribute('data-category');

      if (!file) return;

      // Preview image
      const reader = new FileReader();
      reader.onload = () => {
        preview.src = reader.result;
      };
      reader.readAsDataURL(file);

      // Upload to your Node.js server
      const formData = new FormData();
      formData.append('image', file);
      formData.append('category', category);

      try {
        const response = await fetch('/upload', {
          method: 'POST',
          body: formData,
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.raw || 'Upload failed');

        const imageUrl = data.imageUrl;

        await db.collection('images').doc(category).set({
          imageUrl: imageUrl,
          category: category,
          found: true,
          approved: false,
          rejected: false
        });

        successMsg.innerText = "Pending approval";
        successMsg.style.color = 'green';
      } catch (err) {
          console.error(err);
          successMsg.innerText = "Upload failed!";
          alert(err);
          successMsg.style.color = 'red';
      }
    });
  });

    // List of all required categories
    const allCategories = [
      "red", "leaf", "circle", "toy", "reflection",
      "soft", "triangle", "old", "funny", "tall"
    ];

    const allItemsPopup = document.getElementById("all-items-popup");
    const allItemsOkButton = document.getElementById("all-items-ok");

    // To track which categories have approved images
    let approvedCategories = new Set();

    // Recheck whenever Firestore changes
    db.collection('images').where('approved', '==', true).onSnapshot(snapshot => {
      snapshot.forEach(doc => {
        const data = doc.data();
        if (data.category && allCategories.includes(data.category)) {
          approvedCategories.add(data.category);
        }
      });

      // If all categories are approved, show popup
      if (approvedCategories.size === allCategories.length) {
        allItemsPopup.style.display = 'block';
      }
    });

    // Show rejection message for unapproved images
    db.collection('images').where('rejected', '==', true).onSnapshot(snapshot => {
      snapshot.docChanges().forEach(change => {
        if (change.type === "added" || change.type === "modified") {
          const data = change.doc.data();
          const section = document.querySelector(`.category-section[data-category="${data.category}"]`);
          if (section) {
            const msg = section.querySelector('.success-message');
            msg.innerText = "Rejected. Please upload new image.";
            msg.style.color = 'red';
          }
        }
      });
    });

    // Show approved message for approved images
    db.collection('images').where('approved', '==', true).onSnapshot(snapshot => {
      snapshot.docChanges().forEach(change => {
        if (change.type === "added" || change.type === "modified") {
          const data = change.doc.data();
          const section = document.querySelector(`.category-section[data-category="${data.category}"]`);
          if (section) {
            const msg = section.querySelector('.success-message');
            msg.innerText = "Approved!";
            msg.style.color = 'green';
          }
        }
      });
    });

    // Handle OK button to return to home page
    allItemsOkButton.addEventListener('click', () => {
      allItemsPopup.style.display = 'none';
      window.location.href = '/';
    });

    // Open SMS app on button click
    function openSMS() {
      const phoneNumber = "+19253362076";
      const message = "I need help!";
      const smsUrl = `sms:${phoneNumber}&body=${encodeURIComponent(message)}`;

      // iPhone-compatible fallback
      if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
        window.location.href = `sms:${phoneNumber};?&body=${encodeURIComponent(message)}`;
      } else {
        window.location.href = smsUrl;
      }
      // window.location.href = `sms:${phoneNumber}?body=${encodeURIComponent(message)}`;
    }

  </script>
</body>
</html>
